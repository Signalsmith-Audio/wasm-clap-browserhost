<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>CMake WASM demo</title>
		<style>
			pre.log, details {
				margin: 0;
				border-bottom: 1px solid #EEED;
				margin-bottom: -1px;
			}
			pre.log {
				padding-left: 1em;
			}
			summary pre.log {
				padding-left: 0;
				display: inline-block;
				border: none;
				font-weight: bold;
				cursor: pointer;
			}
			.log-group {
				padding-left: 4em;
			}
		</style>
	</head>
	<body>
		<script type="module">
			import clapModule from './clap-host/clasm.mjs';
			
			// nested log convenience function
			function makeLog(host) {
				function log(...args) {
					let pre = document.createElement('pre');
					pre.classList.add('log');
					pre.textContent = args.join(' ');
					host.append(pre);
				}
				log.group = (...args) => {
					let details = document.createElement('details');
					details.setAttribute('open', 'open');
					let summary = document.createElement('summary');
					let group = document.createElement('div');
					group.classList.add('log-group');
					details.append(summary, group);

					makeLog(summary)(...args);
					host.append(details);
					return makeLog(group);
				}
				return log;
			}
			let log = makeLog(document.body);
			
			(async (url) => {
				let module = await clapModule({
					url: url,
					log: log
				});

				let version = module.version;
				log(`module loaded (CLAP v${version.major}.${version.minor}.${version.patch})`);

				let outerLog = log;
				module.plugins.forEach((descriptor, i) => {
					let version = descriptor.clap_version;
					let log = outerLog.group(`Plugin ${i}: ${descriptor.features.join(', ')} (CLAP v${version.major}.${version.minor}.${version.patch})`);
					// a bunch of string keys
					log(`id = ${descriptor.id}`);
					log(`name = ${descriptor.name}`);
					log(`vendor = ${descriptor.vendor}`);
					log(`url = ${descriptor.url}`);
					log(`manual_url = ${descriptor.manual_url}`);
					log(`support_url = ${descriptor.support_url}`);
					log(`version = ${descriptor.version}`);
					log(`description = ${descriptor.description}`);

					let extLog = log.group(`Extensions:`);
					module.create(descriptor.id).then(plugin => {
						let params = plugin.ext['clap.params'];
						if (params) {
							let log = extLog.group(`clap.params`);
							for (let i = 0; i < params.count(); ++i) {
								let infoPtr = plugin.api.temp(plugin.api.clap_param_info, {});
								params.get_info(i, infoPtr);
								let info = plugin.api.clap_param_info(infoPtr);
								let pLog = log.group(`param ${i}: ${info.name}`);
								pLog(`id = ${info.id}`);
								pLog(`module = ${info.module}`);
								let flags = [];
								let friendlyNames = {
									CLAP_PARAM_IS_STEPPED: 'stepped',
									CLAP_PARAM_IS_PERIODIC: 'periodic',
									CLAP_PARAM_IS_HIDDEN: 'hidden',
									CLAP_PARAM_IS_READONLY: 'readonly',
									CLAP_PARAM_IS_BYPASS: 'bypass',
									CLAP_PARAM_IS_AUTOMATABLE: 'automatable',
									CLAP_PARAM_IS_AUTOMATABLE_PER_NOTE_ID: 'automatable/note',
									CLAP_PARAM_IS_AUTOMATABLE_PER_KEY: 'automatable/key',
									CLAP_PARAM_IS_AUTOMATABLE_PER_CHANNEL: 'automatable/channel',
									CLAP_PARAM_IS_AUTOMATABLE_PER_PORT: 'automatable/port',
									CLAP_PARAM_IS_MODULATABLE: 'modulatable',
									CLAP_PARAM_IS_MODULATABLE_PER_NOTE_ID: 'modulatable/note',
									CLAP_PARAM_IS_MODULATABLE_PER_KEY: 'modulatable/key',
									CLAP_PARAM_IS_MODULATABLE_PER_CHANNEL: 'modulatable/channel',
									CLAP_PARAM_IS_MODULATABLE_PER_PORT: 'modulatable/port',
									CLAP_PARAM_REQUIRES_PROCESS: 'requires-process',
									CLAP_PARAM_IS_ENUM: 'enum',
   								};
								for (let key in friendlyNames) {
									if (info.flags&plugin.api[key]) flags.push(friendlyNames[key]);
								}
								pLog(`flags = ${flags.join(' ')}`);
								pLog(`range = ${info.min_value} - ${info.max_value}`);
								pLog(`default = ${info.default_value}`);
							}
						} else {
							extLog(`clap.params: not found`);
						}
					});
				});
			})('../build-emscripten/hello-clap_artefacts/hello-clap.clasm/hello-clap.wasm').catch(e => log(e.message));
		</script>
	</body>
</html>
